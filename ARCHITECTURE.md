# Архитектура: Telegram бот для генерации превью

## Технологический стек

### Backend
- **Python 3.10+** - основной язык
- **python-telegram-bot** - библиотека для работы с Telegram Bot API
- **Pillow (PIL)** - генерация и обработка изображений
- **requests** - HTTP-клиент для vsellm.ru API

### Дополнительные библиотеки
- **python-dotenv** - управление переменными окружения
- **pydantic** - валидация данных и настроек

## Архитектура бота

### Основные компоненты

```
imgpreviewgen/
├── bot/
│   ├── __init__.py
│   ├── handlers.py          # Обработчики команд и сообщений
│   ├── keyboards.py         # Inline-клавиатуры для выбора стилей
│   └── states.py            # Состояния диалога (ConversationHandler)
├── generator/
│   ├── __init__.py
│   ├── image_generator.py   # Генерация изображений с помощью Pillow
│   ├── ai_generator.py      # Генерация через vsellm.ru API
│   └── templates.py         # Шаблоны дизайна
├── config/
│   ├── __init__.py
│   └── settings.py          # Конфигурация (токены, API keys)
├── assets/
│   ├── fonts/              # Шрифты для текста
│   ├── backgrounds/        # Фоновые изображения
│   └── templates/          # JSON с описанием шаблонов
├── temp/                   # Временные файлы
├── .env                    # Переменные окружения
├── requirements.txt        # Зависимости Python
├── main.py                # Точка входа
└── README.md              # Инструкция по запуску
```

## Подход к генерации изображений

### Вариант 1: Комбинированный (рекомендуемый)

**Pillow для композиции + vsellm.ru для AI-элементов**

1. Используем **Pillow** для:
   - Создание базового изображения с фоном
   - Наложение текста (заголовок, описание)
   - Применение градиентов и фильтров
   - Добавление рамок и декоративных элементов

2. Используем **vsellm.ru API** для (опционально):
   - Генерация AI-иллюстраций по теме поста
   - Создание уникальных фоновых изображений
   - Улучшение пользовательских изображений

**Преимущества:**
- Быстрая генерация простых превью (Pillow)
- Креативные возможности через AI (vsellm.ru)
- Контроль над стилем и позиционированием
- Низкая стоимость (AI только при необходимости)

### Вариант 2: Только Pillow

Простой и надежный вариант для старта:
- Шаблоны с предустановленными фонами
- Программная генерация градиентов
- Четкий контроль над дизайном
- Нулевая стоимость API

## Workflow бота

### Сценарий использования

```
1. /start - Приветствие и инструкция
2. /new - Создать новое превью
   ├─> Выбор стиля (inline keyboard):
   │   ├─ Минимализм
   │   ├─ Градиент
   │   ├─ С иллюстрацией (AI)
   │   └─ Пользовательский фон
   ├─> Ввод заголовка
   ├─> Ввод описания (опционально)
   └─> Генерация и отправка изображения
3. /settings - Настройки (цветовая схема, шрифт)
4. /help - Справка
```

### Состояния ConversationHandler

```python
CHOOSING_STYLE = 0
ENTERING_TITLE = 1
ENTERING_DESCRIPTION = 2
UPLOADING_CUSTOM_BG = 3  # Если выбран пользовательский фон
GENERATING = 4
```

## Интеграция с vsellm.ru

### API Endpoint
```
POST https://api.vsellm.ru/v1/images/generations
```

### Пример запроса (OpenAI-совместимый)
```python
import requests

response = requests.post(
    "https://api.vsellm.ru/v1/images/generations",
    headers={
        "Authorization": f"Bearer {VSELLM_API_KEY}",
        "Content-Type": "application/json"
    },
    json={
        "prompt": "Минималистичная иллюстрация на тему программирования",
        "n": 1,
        "size": "1024x1024",
        "model": "dall-e-3"  # или другая доступная модель
    }
)

image_url = response.json()['data'][0]['url']
```

## Шаблоны дизайна

### 1. Минимализм
- Однотонный фон (белый/черный)
- Крупный заголовок (шрифт sans-serif)
- Акцентная линия или геометрический элемент

### 2. Градиент
- Плавный градиент (2-3 цвета)
- Текст с тенью для читаемости
- Современный вид

### 3. С иллюстрацией
- AI-генерированное изображение фоном
- Полупрозрачный overlay для текста
- Динамичный вид

### 4. Пользовательский
- Загрузка своего изображения
- Автоматическое затемнение/осветление для читаемости

## Конфигурация (.env)

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=your_telegram_bot_token

# vsellm.ru API
VSELLM_API_KEY=your_vsellm_api_key
VSELLM_API_URL=https://api.vsellm.ru/v1

# Image settings
DEFAULT_IMAGE_WIDTH=1280
DEFAULT_IMAGE_HEIGHT=640
IMAGE_FORMAT=PNG
IMAGE_QUALITY=95

# Paths
FONTS_DIR=./assets/fonts
BACKGROUNDS_DIR=./assets/backgrounds
TEMP_DIR=./temp
```

## Основные команды разработки

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Запуск бота
```bash
python main.py
```

### Переменные окружения
Создайте файл `.env` на основе примера выше.

## Следующие шаги реализации

1. ✅ Создать структуру проекта
2. ✅ Настроить конфигурацию
3. ⏳ Реализовать базовый бот с командами
4. ⏳ Создать генератор на Pillow с 2-3 шаблонами
5. ⏳ Интегрировать vsellm.ru для AI-иллюстраций
6. ⏳ Добавить сохранение пресетов пользователя
7. ⏳ Тестирование и оптимизация

## Примечания

- Начнем с простого варианта (Pillow + базовые шаблоны)
- AI-генерацию добавим как опциональную фичу
- Храним пользовательские настройки в памяти (для MVP)
- В будущем можно добавить БД для сохранения истории
