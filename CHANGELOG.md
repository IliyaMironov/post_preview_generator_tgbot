# Changelog

## 2026-01-11 (v2) - Исправление растягивания изображений

### Проблема
AI-сгенерированные изображения растягивались по ширине, потому что квадратные изображения (1024x1024) принудительно масштабировались до 1280x640 без сохранения пропорций.

### Решение
Обновлён метод `generate_ai_only()` для правильного масштабирования:
- **Crop to fit** - изображение масштабируется с сохранением пропорций
- Лишнее обрезается по центру
- Круг остаётся кругом, а не овалом

### Алгоритм
1. Вычисляем соотношение сторон (aspect ratio)
2. Масштабируем так, чтобы заполнить целевой размер
3. Обрезаем лишнее по центру

**Пример:**
- Исходное: 1024x1024 (квадрат)
- Целевое: 1280x640 (соотношение 2:1)
- Масштабируем до: 1280x1280 (по ширине)
- Обрезаем: верх и низ по 320px → финал 1280x640

### Тестирование
```bash
python test_image_scaling.py
```

## 2026-01-11 (v1) - Обновление AI-генерации для мемного стиля

### Изменения

1. **Исправлен API vsellm.ru**
   - Изменён эндпоинт с `/v1/images/generations` на `/v1/chat/completions`
   - Обновлена модель на `google/gemini-2.5-flash-image`
   - Добавлена обработка base64 data URLs из ответа API
   - Увеличен таймаут до 90 секунд

2. **Новый стиль генерации - мемный без текста**
   - AI генерирует яркие, привлекательные иллюстрации
   - Текст больше не добавляется поверх AI-изображения
   - Стиль оптимизирован для Telegram каналов
   - Упор на визуальную привлекательность

3. **Улучшенные промпты**
   - Промпт теперь требует "NO TEXT, NO LETTERS, NO WORDS"
   - Указание на мемный/humorous стиль
   - Яркие цвета и динамичная композиция
   - Учёт описания поста для более точной генерации

4. **Новый метод `generate_ai_only()`**
   - Генерирует чистое AI-изображение без оверлея
   - Без затемнения и текста
   - Масштабирование до 1280x640

5. **Обновлён метод `generate_with_background()`**
   - Добавлен параметр `add_text` (по умолчанию True)
   - Можно отключить наложение текста
   - Оверлей применяется только если `add_text=True`

6. **Исправлена ошибка с numpy**
   - Изменено `if ai_image:` на `if ai_image is not None:`
   - Устранена ошибка "ambiguous truth value"

### Файлы изменены

- `generator/ai_generator.py` - обновлён API и промпты
- `generator/image_generator.py` - добавлен `generate_ai_only()`
- `bot/handlers.py` - использование нового метода генерации

### Тестирование

Созданы тестовые скрипты:
- `test_image_generation.py` - тест разных эндпоинтов
- `test_alternative_models.py` - поиск рабочих моделей
- `test_ai_generator.py` - тест обновлённого генератора
- `test_meme_style.py` - тест мемного стиля

### Результат

Теперь бот генерирует:
- ✅ Яркие, привлекательные иллюстрации
- ✅ Без текста на изображении
- ✅ В мемном стиле, подходящем для Telegram
- ✅ С учётом темы и описания поста
